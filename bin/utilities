#!/bin/bash

SELECTION=${1}
hash dialog 2>/dev/null || { echo Installing dialog \(one time\) ; sudo apt update > /dev/null ; sudo apt install dialog -y > /dev/null ; }
source ${HOME}/.config/omnistream.conf
source ${HOME}/OmniStream/bin/omni_functions

DIALOG_CANCEL=1
DIALOG_ESC=255
HEIGHT=0
WIDTH=0

display_result() {
	dialog --title "${1}" \
		--no-collapse \
		--msgbox "$result" 0 0
}

program_runner() {
	${1} 2>&1 | dialog --programbox 1000 1000
}

# trap ctrl-c and call ctrl_c()
trap ctrl_c INT

while true
do
	exec 3>&1
	SELECTION=$(dialog \
		--backtitle "Omni Controls" \
		--title "Menu" \
		--clear \
		--cancel-label "Exit" \
		--default-item "${SELECTION}" \
		--menu "Please select:" ${HEIGHT} ${WIDTH} 0 \
		"1" "omni up - refresh containers and bring up new ones" \
		"2" "omni down - take down all containers; leave mounts" \
		"3" "omni restart - restart all containers" \
		"4" "omni update - update all running Omni containers with latest build" \
		"5" "omni status - show the status of running containers" \
		"6" "omni stats - show realtime stats (ctrl-c to exit)" \
		"7" "omni repair - force update OmniStream to latest version" \
		"8" "dns report - show a report of DNS entries for active containers" \
		"9" "update - run updates for operating system" \
		"A " "rstats - monitor active rclone transfers" \
		"B" "turbosync - manually trigger sync of cached files up to cloud" \
		2>&1 1>&3)
	EXIT_STATUS=${?}
	exec 3>&-
	case ${EXIT_STATUS} in
		${DIALOG_CANCEL})
			clear
			echo "Program terminated."
			exit
			;;
		${DIALOG_ESC})
			clear
			echo "Program aborted." >&2
			exit 1
			;;
	esac
	case ${SELECTION} in
		1 )
			clear
			omni up
			;;
		2 )
			clear
			omni down
			;;
		3 )
			clear
			omni restart
			;;
		4 )
			clear
			omni update
			;;
		5 )
			result=$(omni status)
			display_result "Omni Status"
			;;
		6 )
			clear
			omni stats
			;;
		7 )
			clear
			omni repair
			;;
		8 )
			dns-report-gen
			result=$(cat "${OMNIHOME}/dns-report")
			display_result "DNS Report"
			;;
		9 )
			program_runner update
			;;
		"A" )
			docker exec -ti omnimount /root/rstats
			;;
		"B" )
			program_runner turbosync
			;;
	esac
done
