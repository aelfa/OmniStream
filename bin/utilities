#!/bin/bash

#if ! dpkg-query -W -f='${Status}' dialog  | grep "Dialog command found"; then sudo apt install dialog -y ; fi
hash dialog 2>/dev/null || { echo Installing dialog \(one time\) ; sudo apt update > /dev/null ; sudo apt install dialog -y > /dev/null ; }
source ${HOME}/.config/omnistream.conf
source ${HOME}/Omni/bin/omni_functions

DIALOG_CANCEL=1
DIALOG_ESC=255
HEIGHT=0
WIDTH=0

display_result() {
  dialog --title "${1}" \
    --no-collapse \
    --msgbox "$result" 0 0
}

program_runner() {
	${1} 2>&1 | dialog --programbox 1000 1000
}

while true; do
  exec 3>&1
  SELECTION=$(dialog \
    --backtitle "Omni Controls" \
    --title "Menu" \
    --no-tags \
    --clear \
    --cancel-label "Exit" \
    --menu "Please select:" ${HEIGHT} ${WIDTH} 5 \
    "1" "rclean - Reset everything" \
    "2" "omni up - refresh containers and bring up new ones" \
    "3" "omni down - take down all containers; leave mounts" \
    "4" "omni fullstop - take down everything inc. mounts" \
    "5" "omni update - update all running Omni containers" \
    "6" "omni status - show the status of running containers" \
    "7" "update - run updates for operating system" \
    2>&1 1>&3)
  EXIT_STATUS=${?}
  exec 3>&-
  case ${EXIT_STATUS} in
    ${DIALOG_CANCEL})
      clear
      echo "Program terminated."
      exit
      ;;
    ${DIALOG_ESC})
      clear
      echo "Program aborted." >&2
      exit 1
      ;;
  esac
  case ${SELECTION} in
    1 )
      rclean
      ;;
    2 )
      omni up
      ;;
    3 )
      omni down
      ;;
    4 )
      omni fullstop
      ;;
    5 )
      program_runner "omni update"
      ;;
    6 )
      result=$(omni status)
      display_result "Omni Status"
      ;;
    7 )
      program_runner update
      ;;
  esac
done
